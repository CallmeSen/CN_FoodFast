name: CD Pipeline - Docker Desktop K8s

on:
  push:
    branches:
      - main
    paths:
      - "infra/k8s/**"
      - ".github/workflows/deploy-k8s.yml"
  pull_request:
    branches:
      - main

  release:
    types: [published]
  # workflow_dispatch:
    # inputs:
      # environment:
      #   description: "Deployment environment"
      #   required: false
      #   default: "production"
      #   type: choice
      #   options:
      #     - staging
  workflow_run:
    workflows: ["backend-ci", "frontend-ci"]
    types:
      - completed
    branches:
      - main  #

jobs:
  build-and-deploy:
    runs-on: self-hosted # Chạy trên máy local với Docker Desktop

    steps:
      - name: Clean temp directory
        shell: powershell
        run: |
          if (Test-Path "$env:RUNNER_TEMP") {
            Get-ChildItem -Path "$env:RUNNER_TEMP" -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          }
          $workDir = "E:\GitHub\actions-runner\_work\_temp"
          if (Test-Path $workDir) {
            Get-ChildItem -Path $workDir -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          }
          echo "✓ Temp cleanup completed"
        continue-on-error: true

      - name: Checkout code
        uses: actions/checkout@v3

      # 1️⃣ Đăng nhập vào DockerHub
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3️⃣ Verify Docker Desktop Kubernetes
      - name: Check Kubernetes context
        run: |
          kubectl config current-context
          kubectl cluster-info
          kubectl get nodes

      # 4️⃣ Deploy to Docker Desktop Kubernetes
      - name: Prepare Namespace and Base Resources
        run: |
          # Apply base resources
          kubectl apply -f infra/k8s/namespace.yaml
          kubectl apply -f infra/k8s/pvcs.yaml

      - name: Deploy MongoDB Services
        run: |
          # Deploy MongoDB instances
          kubectl apply -f infra/k8s/auth-service-mongo.yaml
          kubectl apply -f infra/k8s/restaurant-service-mongo.yaml
          kubectl apply -f infra/k8s/order-service-mongo.yaml
          kubectl apply -f infra/k8s/payment-service-mongo.yaml

          echo "Waiting for MongoDB StatefulSets to be ready (may take 2-3 minutes)..."
          Start-Sleep -Seconds 20

          # Wait for StatefulSets (not pods directly)
          kubectl rollout status statefulset/mongodb-auth -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Auth MongoDB timeout, continuing..." }

          kubectl rollout status statefulset/mongodb-restaurant -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Restaurant MongoDB timeout, continuing..." }

          kubectl rollout status statefulset/mongodb-order -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Order MongoDB timeout, continuing..." }

          kubectl rollout status statefulset/mongodb-payment -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Payment MongoDB timeout, continuing..." }

          echo "MongoDB deployment completed!"
        continue-on-error: true

      - name: Deploy Backend Microservices
        run: |
          Start-Sleep -Seconds 10

          # Deploy new backend services
          kubectl apply -f infra/k8s/auth-service-deployment.yaml
          kubectl apply -f infra/k8s/auth-service-service.yaml
          kubectl apply -f infra/k8s/restaurant-service-deployment.yaml
          kubectl apply -f infra/k8s/restaurant-service-service.yaml
          kubectl apply -f infra/k8s/order-service-deployment.yaml
          kubectl apply -f infra/k8s/order-service-service.yaml
          kubectl apply -f infra/k8s/payment-service-deployment.yaml
          kubectl apply -f infra/k8s/payment-service-service.yaml

      - name: Deploy Frontend Apps
        run: |
          Start-Sleep -Seconds 10

          # Deploy new frontends
          kubectl apply -f infra/k8s/client-frontend-deployment.yaml
          kubectl apply -f infra/k8s/client-frontend-service.yaml
          kubectl apply -f infra/k8s/admin-frontend-deployment.yaml
          kubectl apply -f infra/k8s/admin-frontend-service.yaml
          kubectl apply -f infra/k8s/restaurant-frontend-deployment.yaml
          kubectl apply -f infra/k8s/restaurant-frontend-service.yaml

      - name: Deploy Nginx Gateway
        run: |
          kubectl apply -f infra/k8s/nginx-configmap.yaml
          kubectl apply -f infra/k8s/nginx-deployment.yaml
          kubectl apply -f infra/k8s/nginx-service.yaml

      - name: Wait for deployments to be ready
        run: |
          echo "Waiting for services to be ready (this may take 2-3 minutes)..."

          kubectl rollout status deployment/auth-service -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Auth service timeout" }

          kubectl rollout status deployment/restaurant-service -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Restaurant service timeout" }

          kubectl rollout status deployment/order-service -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Order service timeout" }

          kubectl rollout status deployment/payment-service -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Payment service timeout" }

          kubectl rollout status deployment/client-frontend -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Client frontend timeout" }

          kubectl rollout status deployment/admin-frontend -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Admin frontend timeout" }

          kubectl rollout status deployment/restaurant-frontend -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Restaurant frontend timeout" }

          kubectl rollout status deployment/nginx-gateway -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Nginx timeout" }

          echo "Deployment rollout completed!"
        continue-on-error: true

      # # 5️⃣ Deploy Monitoring Stack
      # - name: Deploy Monitoring Stack
      #   run: |
      #     # Delete existing monitoring stack if exists
      #     kubectl delete namespace monitoring --ignore-not-found=true
      #     Start-Sleep -Seconds 10

      #     echo "Deploying Prometheus, Grafana, and Loki..."
      #     kubectl apply -f infra/k8s/monitoring/namespace.yaml

      #     # Deploy Prometheus
      #     kubectl apply -f infra/k8s/monitoring/prometheus.yaml

      #     # Deploy Grafana
      #     kubectl apply -f infra/k8s/monitoring/grafana.yaml

      #     # Deploy Loki & Promtail
      #     kubectl apply -f infra/k8s/monitoring/loki.yaml

      #     echo "Waiting for monitoring stack to be ready..."
      #     Start-Sleep -Seconds 20

      #     kubectl rollout status deployment/prometheus -n cnpm-food-delivery --timeout=3m
      #     if ($LASTEXITCODE -ne 0) { echo "Warning: Prometheus timeout" }

      #     kubectl rollout status deployment/grafana -n cnpm-food-delivery --timeout=3m
      #     if ($LASTEXITCODE -ne 0) { echo "Warning: Grafana timeout" }

      #     kubectl rollout status deployment/loki -n cnpm-food-delivery --timeout=3m
      #     if ($LASTEXITCODE -ne 0) { echo "Warning: Loki timeout" }

      #     echo "Monitoring stack deployed!"
      #   continue-on-error: true

      # # 5️⃣ Deploy jobs, cronjobs if any
      # - name: Deploy Jobs and CronJobs
      #   run: |
      #     kubectl apply -f infra/k8s/jobs/
      #     start-sleep -Seconds 10
      #     echo "Jobs and CronJobs deployment completed!"

      # 6️⃣ Verify deployment !
      - name: Verify Deployment
        run: |
          echo "=== All Pods (App + Monitoring) ==="
          kubectl get pods -n cnpm-food-delivery
          echo ""
          echo "=== All Services (App + Monitoring) ==="
          kubectl get svc -n cnpm-food-delivery
          echo ""
          echo "=== All Deployments ==="
          kubectl get deployments -n cnpm-food-delivery
          echo ""