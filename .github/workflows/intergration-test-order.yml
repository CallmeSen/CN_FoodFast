name: Order Service Integration Test

on:
  push:
    branches:
      - main
      - source
    paths:
      - 'server/apps/order-service/**'
      - '.github/workflows/intergration-test-order.yml'
  pull_request:
    branches:
      - main
      - source
    paths:
      - 'server/apps/order-service/**'
  workflow_dispatch:

jobs:
  setup-infrastructure:
    name: Start Docker Compose Stack
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Docker Compose Stack
        shell: powershell
        working-directory: server
        run: |
          Write-Host "Checking CN_FoodFast Docker Compose stack..." -ForegroundColor Cyan
          
          $running = docker-compose ps -q 2>$null | Out-String
          
          if ($running) {
            Write-Host "Stack already running, checking health..." -ForegroundColor Green
            docker-compose ps
          } else {
            Write-Host "Starting Docker Compose stack..." -ForegroundColor Yellow
            docker-compose up -d orderdb rabbitmq
            
            Write-Host "`nWaiting for services to be ready..." -ForegroundColor Cyan
            Start-Sleep -Seconds 15
          }
          
          Write-Host "`nDocker Compose Services Status:" -ForegroundColor Cyan
          docker-compose ps
          
          Write-Host "`nPostgreSQL Health Check:" -ForegroundColor Cyan
          docker ps --filter "name=orderdb" --format "table {{.Names}}\t{{.Status}}"
          
  order-integration-test:
    name: Order Service Integration Test
    runs-on: self-hosted
    needs: setup-infrastructure
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        shell: powershell
        working-directory: server/apps/order-service
        run: npm ci

      - name: Run Integration Tests
        shell: powershell
        working-directory: server/apps/order-service
        run: |
          Write-Host "Starting Order Service Integration Tests..." -ForegroundColor Cyan
          npm run test:integration 2>&1 | Tee-Object -FilePath order-integration-test.log
          exit $LASTEXITCODE
        continue-on-error: true

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: order-integration-test-logs
          path: server/apps/order-service/order-integration-test.log
          retention-days: 7

      - name: Push Order Logs to Loki
        if: always()
        shell: powershell
        working-directory: server/apps/order-service
        env:
          LOKI_URL: ${{ secrets.LOKI_URL }}
          LOKI_USERNAME: ${{ secrets.LOKI_USERNAME }}
          LOKI_PASSWORD: ${{ secrets.LOKI_PASSWORD }}
        run: |
          if (-not $env:LOKI_URL) {
            Write-Host "WARNING: LOKI_URL not configured, skipping log export" -ForegroundColor Yellow
            exit 0
          }
          
          if (-not (Test-Path "order-integration-test.log")) {
            Write-Host "WARNING: Log file not found" -ForegroundColor Yellow
            exit 0
          }
          
          Write-Host "Pushing Order Service logs to Loki..." -ForegroundColor Cyan
          
          # Create Python script file for Loki payload
          $pythonScript = @"
          import json, os, time, re
          from pathlib import Path
          from datetime import datetime
          
          log_file = "order-integration-test.log"
          if not Path(log_file).exists():
              exit(0)
          
          with open(log_file, "r", encoding="utf-8", errors="ignore") as f:
              content = f.read()
          
          suites_match = re.search(r"Test Suites:\s*(\d+)\s*failed.*?(\d+)\s*passed.*?(\d+)\s*total", content)
          tests_match = re.search(r"Tests:\s*(\d+)\s*failed.*?(\d+)\s*passed.*?(\d+)\s*total", content)
          time_match = re.search(r"Time:\s*([\d.]+)\s*s", content)
          
          suites_failed = suites_match.group(1) if suites_match else "0"
          suites_passed = suites_match.group(2) if suites_match else "0"
          suites_total = suites_match.group(3) if suites_match else "0"
          tests_failed = tests_match.group(1) if tests_match else "0"
          tests_passed = tests_match.group(2) if tests_match else "0"
          tests_total = tests_match.group(3) if tests_match else "0"
          test_time = time_match.group(1) if time_match else "0"
          
          pass_tests = re.findall(r"PASS\s+(src[^\n]+)", content)
          fail_tests = re.findall(r"FAIL\s+(src[^\n]+)", content)
          
          test_status = "passed" if int(tests_failed) == 0 else "failed"
          
          timestamp = datetime.now().strftime("[%Y-%m-%d %H:%M:%S]")
          summary_lines = [
              timestamp,
              f"Test Suites: {suites_failed} failed, {suites_passed} passed, {suites_total} total",
              f"Tests:       {tests_failed} failed, {tests_passed} passed, {tests_total} total",
              "Snapshots:   0 total",
              f"Time:        {test_time} s",
              "",
              "Success Test:"
          ]
          for t in pass_tests:
              summary_lines.append(f" PASS  {t}")
          summary_lines.append("")
          summary_lines.append("Error Test:")
          for t in fail_tests:
              summary_lines.append(f" FAIL  {t}")
          
          labels = {
              "job": "integration-tests",
              "service": "order",
              "repo": os.environ.get("GITHUB_REPOSITORY", "unknown"),
              "workflow": os.environ.get("GITHUB_WORKFLOW", "unknown"),
              "run_id": os.environ.get("GITHUB_RUN_ID", "unknown"),
              "run_number": os.environ.get("GITHUB_RUN_NUMBER", "unknown"),
              "branch": os.environ.get("GITHUB_REF_NAME", "unknown"),
              "commit": os.environ.get("GITHUB_SHA", "unknown")[:7],
              "test_status": test_status,
              "log_type": "integration-test",
              "environment": "ci"
          }
          
          values = []
          base_ts = int(time.time() * 1e9)
          
          for idx, line in enumerate(summary_lines):
              values.append([str(base_ts + idx * 1000), line])
          
          with open("loki-payload.json", "w", encoding="utf-8") as f:
              json.dump({"streams": [{"stream": labels, "values": values}]}, f)
          
          print(f"Prepared {len(values)} log lines (status: {test_status})")
          for line in summary_lines:
              print(line)
          "@
          $pythonScript | Set-Content -Path "generate_loki_payload.py" -Encoding ASCII
          
          python generate_loki_payload.py
          
          if (-not (Test-Path "loki-payload.json")) {
            Write-Host "ERROR: Failed to generate payload" -ForegroundColor Red
            exit 1
          }
          
          # Push to Loki using curl
          if ($env:LOKI_USERNAME -and $env:LOKI_PASSWORD) {
            Write-Host "Using basic authentication" -ForegroundColor Cyan
            $response = curl.exe -sS -w "`n%{http_code}" -X POST `
              -u "${env:LOKI_USERNAME}:${env:LOKI_PASSWORD}" `
              -H "Content-Type: application/json" `
              $env:LOKI_URL `
              --data-binary "@loki-payload.json" 2>&1
          } else {
            Write-Host "No authentication (LOKI_USERNAME not set)" -ForegroundColor Yellow
            $response = curl.exe -sS -w "`n%{http_code}" -X POST `
              -H "Content-Type: application/json" `
              $env:LOKI_URL `
              --data-binary "@loki-payload.json" 2>&1
          }
          
          $lines = $response -split "`n"
          $httpCode = $lines[-1]
          
          if ($httpCode -eq "204" -or $httpCode -eq "200") {
            Write-Host "SUCCESS: Pushed Order logs to Loki (HTTP $httpCode)" -ForegroundColor Green
          } else {
            Write-Host "ERROR: Failed to push logs (HTTP $httpCode)" -ForegroundColor Red
            Write-Host "Response: $($lines[0..$($lines.Length-2)] -join "`n")"
            exit 1
          }
