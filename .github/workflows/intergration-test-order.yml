name: Order Service Integration Test

on:
  push:
    branches:
      - main
      - source
    paths:
      - 'server/apps/order-service/**'
      - '.github/workflows/intergration-test-order.yml'
  pull_request:
    branches:
      - main
      - source
    paths:
      - 'server/apps/order-service/**'
  workflow_dispatch:

jobs:
  setup-infrastructure:
    name: Start Docker Compose Stack
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Docker Compose Stack
        shell: powershell
        working-directory: server
        run: |
          Write-Host "Checking CN_FoodFast Docker Compose stack..." -ForegroundColor Cyan
          
          $running = docker-compose ps -q 2>$null | Out-String
          
          if ($running) {
            Write-Host "Stack already running, checking health..." -ForegroundColor Green
            docker-compose ps
          } else {
            Write-Host "Starting Docker Compose stack..." -ForegroundColor Yellow
            docker-compose up -d orderdb rabbitmq
            
            Write-Host "`nWaiting for services to be ready..." -ForegroundColor Cyan
            Start-Sleep -Seconds 15
          }
          
          Write-Host "`nDocker Compose Services Status:" -ForegroundColor Cyan
          docker-compose ps
          
          Write-Host "`nPostgreSQL Health Check:" -ForegroundColor Cyan
          docker ps --filter "name=orderdb" --format "table {{.Names}}\t{{.Status}}"
          
  order-integration-test:
    name: Order Service Integration Test
    runs-on: self-hosted
    needs: setup-infrastructure
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        shell: powershell
        working-directory: server/apps/order-service
        run: npm ci

      - name: Run Integration Tests
        shell: powershell
        working-directory: server/apps/order-service
        run: |
          $ErrorActionPreference = 'Continue'
          Write-Host "Starting Order Service Integration Tests..." -ForegroundColor Cyan
          $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          Write-Host "[$timestamp] Test execution started" -ForegroundColor Green
          
          $logFile = "order-integration-test.log"
          npm run test:integration *>&1 | ForEach-Object {
            $_ | Out-File -FilePath $logFile -Append -Encoding utf8
            Write-Host $_
          }
          
          $exitCode = $LASTEXITCODE
          $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          
          if ($exitCode -eq 0) {
            $status = "PASSED"
            $color = "Green"
          } else {
            $status = "FAILED"
            $color = "Red"
          }
          
          $statusMsg = "[$timestamp] Order tests $status (exit code: $exitCode)"
          Write-Host $statusMsg -ForegroundColor $color
          $statusMsg | Out-File -FilePath $logFile -Append -Encoding utf8
          
          if ($exitCode -ne 0) { exit $exitCode }
        continue-on-error: true

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: order-integration-test-logs
          path: server/apps/order-service/order-integration-test.log
          retention-days: 7

      - name: Push logs to Grafana Loki
        if: always()
        shell: powershell
        working-directory: server/apps/order-service
        env:
          LOKI_URL: ${{ secrets.GRAFANA_LOKI_URL }}
          LOKI_USERNAME: ${{ secrets.GRAFANA_LOKI_USERNAME }}
          LOKI_API_KEY: ${{ secrets.GRAFANA_LOKI_API_KEY }}
        run: |
          $logFile = "order-integration-test.log"
          
          if (-not (Test-Path $logFile)) {
            Write-Host "No log file found, skipping Loki push" -ForegroundColor Yellow
            exit 0
          }
          
          Write-Host "Pushing logs to Grafana Loki..." -ForegroundColor Cyan
          
          $logContent = Get-Content $logFile -Raw -ErrorAction SilentlyContinue
          if (-not $logContent) {
            Write-Host "Log file is empty" -ForegroundColor Yellow
            exit 0
          }
          
          $timestamp = [DateTimeOffset]::UtcNow.ToUnixTimeMilliseconds() * 1000000
          
          $payload = @{
            streams = @(
              @{
                stream = @{
                  job = "github-actions"
                  service = "order-service"
                  type = "integration-test"
                  repository = "${{ github.repository }}"
                  branch = "${{ github.ref_name }}"
                  commit = "${{ github.sha }}"
                  run_id = "${{ github.run_id }}"
                  workflow = "order-integration-test"
                }
                values = @(
                  @("$timestamp", $logContent)
                )
              }
            )
          } | ConvertTo-Json -Depth 10 -Compress
          
          $headers = @{
            "Content-Type" = "application/json"
          }
          
          $auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("${env:LOKI_USERNAME}:${env:LOKI_API_KEY}"))
          $headers["Authorization"] = "Basic $auth"
          
          try {
            Invoke-RestMethod -Uri "${env:LOKI_URL}/loki/api/v1/push" -Method Post -Headers $headers -Body $payload
            Write-Host "Logs pushed to Loki successfully!" -ForegroundColor Green
          } catch {
            Write-Host "Failed to push logs to Loki: $_" -ForegroundColor Red
          }
