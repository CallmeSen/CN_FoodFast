name: CD Pipeline - Docker Compose

on:
  push:
    branches:
      - source
    paths:
      - "server/**"
      - ".github/workflows/deploy-k8s.yml"
  pull_request:
    branches:
      - source

  release:
    types: [published]

  workflow_run:
    workflows: ["backend-ci", "frontend-ci"]
    types:
      - completed
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Clean temp directory
        shell: powershell
        run: |
          if (Test-Path "$env:RUNNER_TEMP") {
            Get-ChildItem -Path "$env:RUNNER_TEMP" -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          }
          echo "✓ Temp cleanup completed"
        continue-on-error: true

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Deploy with Docker Compose
        shell: powershell
        working-directory: server
        run: |
          Write-Host "Building and deploying services..." -ForegroundColor Cyan
          
          # Stop existing containers
          docker-compose down --remove-orphans 2>$null
          
          # Build and start all services
          docker-compose up -d --build
          
          Write-Host "Waiting for services to be healthy..." -ForegroundColor Yellow
          Start-Sleep -Seconds 30
          
          # Check service health
          docker-compose ps
          
          Write-Host "Deployment completed!" -ForegroundColor Green

      - name: Health Check
        shell: powershell
        run: |
          Write-Host "Checking service health..." -ForegroundColor Cyan
          
          $services = @(
            @{Name="API Gateway"; Port=8743},
            @{Name="User Service"; Port=3001},
            @{Name="Product Service"; Port=3002},
            @{Name="Order Service"; Port=3003},
            @{Name="Payment Service"; Port=3004},
            @{Name="Email Service"; Port=3005},
            @{Name="Socket Gateway"; Port=4000}
          )
          
          foreach ($service in $services) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:$($service.Port)/health" -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                Write-Host "✓ $($service.Name) is healthy" -ForegroundColor Green
              }
            } catch {
              Write-Host "✗ $($service.Name) health check failed" -ForegroundColor Red
            }
          }

      - name: Show running containers
        shell: powershell
        working-directory: server
        run: |
          docker-compose ps
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
