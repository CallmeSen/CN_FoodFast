name: Product Service Integration Test

on:
  push:
    branches:
      - main
      - source
    paths:
      - 'server/apps/product-service/**'
      - '.github/workflows/intergration-test-restaurant.yml'
  pull_request:
    branches:
      - main
      - source
    paths:
      - 'server/apps/product-service/**'
  workflow_dispatch:

jobs:
  setup-infrastructure:
    name: Start Docker Compose Stack
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Docker Compose Stack
        shell: powershell
        working-directory: server
        run: |
          Write-Host "Checking CN_FoodFast Docker Compose stack..." -ForegroundColor Cyan
          
          $running = docker-compose ps -q 2>$null | Out-String
          
          if ($running) {
            Write-Host "Stack already running, checking health..." -ForegroundColor Green
            docker-compose ps
          } else {
            Write-Host "Starting Docker Compose stack..." -ForegroundColor Yellow
            docker-compose up -d productdb rabbitmq
            
            Write-Host "`nWaiting for services to be ready..." -ForegroundColor Cyan
            Start-Sleep -Seconds 15
          }
          
          Write-Host "`nDocker Compose Services Status:" -ForegroundColor Cyan
          docker-compose ps
          
          Write-Host "`nPostgreSQL Health Check:" -ForegroundColor Cyan
          docker ps --filter "name=productdb" --format "table {{.Names}}\t{{.Status}}"

  product-integration-test:
    name: Product Service Integration Test
    runs-on: self-hosted
    needs: setup-infrastructure
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        shell: powershell
        working-directory: server/apps/product-service
        run: npm ci

      - name: Run Integration Tests
        shell: powershell
        working-directory: server/apps/product-service
        run: |
          Write-Host "Starting Product Service Integration Tests..." -ForegroundColor Cyan
          npm run test:integration 2>&1 | Tee-Object -FilePath product-integration-test.log
          exit $LASTEXITCODE
        continue-on-error: true

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: product-integration-test-logs
          path: server/apps/product-service/product-integration-test.log
          retention-days: 7

      - name: Push Product Logs to Loki
        if: always()
        shell: powershell
        working-directory: server/apps/product-service
        env:
          LOKI_URL: ${{ secrets.LOKI_URL }}
          LOKI_USERNAME: ${{ secrets.LOKI_USERNAME }}
          LOKI_PASSWORD: ${{ secrets.LOKI_PASSWORD }}
        run: |
          if (-not $env:LOKI_URL) {
            Write-Host "WARNING: LOKI_URL not configured, skipping log export" -ForegroundColor Yellow
            exit 0
          }
          
          if (-not (Test-Path "product-integration-test.log")) {
            Write-Host "WARNING: Log file not found" -ForegroundColor Yellow
            exit 0
          }
          
          Write-Host "Pushing Product Service logs to Loki..." -ForegroundColor Cyan
          
          # Generate Python script for Loki payload (inline like CNPM-Final-Project)
          $script = 'import json,os,time,re;from pathlib import Path;log_file=""product-integration-test.log"";'
          $script += 'exit(0) if not Path(log_file).exists() else None;'
          $script += 'f=open(log_file,""r"",encoding=""utf-8"",errors=""ignore"");content=f.read();f.close();'
          $script += 'match=re.search(r""(\[\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\].*?)$"",content,re.DOTALL);'
          $script += 'summary=match.group(1).strip() if match else (content[-2000:] if len(content)>2000 else content);'
          $script += 'test_status=""failed"" if ""FAIL"" in summary or ""failed"" in summary else ""passed"";'
          $script += 'labels={""job"":""integration-tests"",""service"":""product"",""repo"":os.environ.get(""GITHUB_REPOSITORY"",""unknown""),""workflow"":os.environ.get(""GITHUB_WORKFLOW"",""unknown""),""run_id"":os.environ.get(""GITHUB_RUN_ID"",""unknown""),""run_number"":os.environ.get(""GITHUB_RUN_NUMBER"",""unknown""),""branch"":os.environ.get(""GITHUB_REF_NAME"",""unknown""),""commit"":os.environ.get(""GITHUB_SHA"",""unknown"")[:7],""test_status"":test_status,""log_type"":""integration-test"",""environment"":""ci""};'
          $script += 'values=[[str(int(time.time()*1e9)),summary]];'
          $script += 'f=open(""loki-payload.json"",""w"",encoding=""utf-8"");json.dump({""streams"":[{""stream"":labels,""values"":values}]},f);f.close();'
          $script += 'print(f""Prepared log (status: {test_status})"");print(summary)'
          
          python -c $script
          
          if (-not (Test-Path "loki-payload.json")) {
            Write-Host "ERROR: Failed to generate payload" -ForegroundColor Red
            exit 1
          }
          
          # Push to Loki using curl
          if ($env:LOKI_USERNAME -and $env:LOKI_PASSWORD) {
            Write-Host "Using basic authentication" -ForegroundColor Cyan
            $response = curl.exe -sS -w "`n%{http_code}" -X POST `
              -u "${env:LOKI_USERNAME}:${env:LOKI_PASSWORD}" `
              -H "Content-Type: application/json" `
              $env:LOKI_URL `
              --data-binary "@loki-payload.json" 2>&1
          } else {
            Write-Host "No authentication (LOKI_USERNAME not set)" -ForegroundColor Yellow
            $response = curl.exe -sS -w "`n%{http_code}" -X POST `
              -H "Content-Type: application/json" `
              $env:LOKI_URL `
              --data-binary "@loki-payload.json" 2>&1
          }
          
          $lines = $response -split "`n"
          $httpCode = $lines[-1]
          
          if ($httpCode -eq "204" -or $httpCode -eq "200") {
            Write-Host "SUCCESS: Pushed Product logs to Loki (HTTP $httpCode)" -ForegroundColor Green
          } else {
            Write-Host "ERROR: Failed to push logs (HTTP $httpCode)" -ForegroundColor Red
            Write-Host "Response: $($lines[0..$($lines.Length-2)] -join "`n")"
            exit 1
          }
